/*
 * 名称: 网管系统应用服务器(处理告警)
 *
 * 修改记录:
 * 付志刚 -		2008-10-18 创建 
 */
 
#include <ebdgdl.h>
#include <applserver.h>

ALARMPARAMETER struAlarmPara;


RESULT InitAlarmPara(int nNeId)
{
    struAlarmPara.nNeId = nNeId;
    return NORMAL;
}

BOOL ExistTransferAlarm( int nRepeateId, int nDeviceId, int nAlarmId)
{
	CURSORSTRU struCursor;
	STR szSql[MAX_SQL_LEN];
	INT nNeId, nCount;
	TBINDVARSTRU struBindVar;
	
	memset(&struBindVar, 0, sizeof(struBindVar));
	
	//近端机 光收发告警
	if (nDeviceId == 0 && nAlarmId == 14) 
	{
		struBindVar.struBind[0].nVarType = SQLT_INT;
		struBindVar.struBind[0].VarValue.nValueInt =  nRepeateId;
		struBindVar.nVarCount++;
		//查找远端机neid
		sprintf(szSql,"select ne_neid from ne_element t where t.ne_repeaterid  = :v_0 and t.ne_deviceid = 1");
		PrintDebugLog(DBG_HERE,"执行SQL语句[%s][%d]\n", szSql, nRepeateId);
		if(BindSelectTableRecord(szSql,&struCursor, &struBindVar) != NORMAL)
		{
			PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
			return BOOLFALSE;
		}
		if (FetchCursor(&struCursor) != NORMAL)
		{
			FreeCursor(&struCursor);
			PrintDebugLog(DBG_HERE, "查找远端机无记录[%d]\n", nRepeateId);
	        return BOOLFALSE;
		}
		nNeId = atoi(GetTableFieldValue(&struCursor,"ne_neid"));
		FreeCursor(&struCursor);
		
		
		struBindVar.struBind[0].VarValue.nValueInt =  nNeId;
		
		sprintf(szSql,"select count(*) as almcount from tf_alarmlog_trigger t where t.alg_neid = :v_0 and (t.alg_alarmid = 1 or t.alg_alarmid = 19)");
		PrintDebugLog(DBG_HERE,"执行SQL语句[%s][%d]\n", szSql, nNeId);
		if(BindSelectTableRecord(szSql,&struCursor, &struBindVar) != NORMAL)
		{
			PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
			return BOOLFALSE;
		}
		if (FetchCursor(&struCursor) == NORMAL)
		{
			nCount = atoi(GetTableFieldValue(&struCursor,"almcount"));
			FreeCursor(&struCursor);
			if (nCount > 0)
				return BOOLTRUE;
			else
	        	return BOOLFALSE;
		}
	}
	//效果监控 电源掉电告警 接收电平强度告警
	if (nDeviceId == 255 && (nAlarmId == 1 || nAlarmId == 137)) 
	{
		struBindVar.struBind[0].nVarType = SQLT_INT;
		struBindVar.struBind[0].VarValue.nValueInt =  nRepeateId;
		struBindVar.nVarCount++;
		//查找远端机neid
		sprintf(szSql,"select ne_effects_id from ne_element t where t.ne_repeaterid  = :v_0 and t.ne_deviceid = 255");
		PrintDebugLog(DBG_HERE,"执行SQL语句[%s][%d]\n", szSql, nRepeateId);
		if(BindSelectTableRecord(szSql,&struCursor, &struBindVar) != NORMAL)
		{
			PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
			return BOOLFALSE;
		}
		if (FetchCursor(&struCursor) != NORMAL)
		{
			FreeCursor(&struCursor);
			PrintDebugLog(DBG_HERE, "查找远端机无记录[%d]\n", nRepeateId);
	        return BOOLFALSE;
		}
		nNeId = atoi(GetTableFieldValue(&struCursor,"ne_effects_id"));
		FreeCursor(&struCursor);
		
		struBindVar.struBind[0].VarValue.nValueInt =  nNeId;
		//查找是否有派单
		if (nAlarmId == 1)
			sprintf(szSql,"select count(*) as almcount from tf_alarmlog_trigger t where t.alg_neid = :v_0 and t.alg_alarmid = 1");
		else
			sprintf(szSql,"select count(*) as almcount from tf_alarmlog_trigger t where t.alg_neid = :v_0 and (t.alg_alarmid = 1 or t.alg_alarmid = 19)");
		PrintDebugLog(DBG_HERE,"执行SQL语句[%s][%d]\n", szSql, nNeId);
		if(BindSelectTableRecord(szSql,&struCursor, &struBindVar) != NORMAL)
		{
			PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
			return BOOLFALSE;
		}
		if (FetchCursor(&struCursor) == NORMAL)
		{
			nCount = atoi(GetTableFieldValue(&struCursor,"almcount"));
			FreeCursor(&struCursor);
			if (nCount > 0)
				return BOOLTRUE;
			else
	        	return BOOLFALSE;
		}
	}
	return BOOLFALSE;
}

RESULT SaveAlarmLog(int nNeId)
{
    CURSORSTRU struCursor;
	STR szSql[MAX_SQL_LEN];
	UINT nAlarmLogId;
	//STR szAlarmObjList[1000];
	STR szOldAlarmObjId[20];
	STR szNewAlarmObjId[20];
	PSTR pszTemp;
	INT nAlarmId;
	TBINDVARSTRU struBindVar;
	
	memset(&struBindVar, 0, sizeof(struBindVar));

	struBindVar.struBind[0].nVarType = SQLT_STR;
	strcpy(struBindVar.struBind[0].VarValue.szValueChar, struAlarmPara.szAlarmObjId);
		
	struBindVar.nVarCount++;
		
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "select * from ALM_ALARM where alm_ObjId = :v_0 ");
	PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%s]\n", szSql,  struAlarmPara.szAlarmObjId);
	if(BindSelectTableRecord(szSql, &struCursor, &struBindVar) != NORMAL)
	{
		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
					  szSql, GetSQLErrorMessage());
		return EXCEPTION;
	}
	if(FetchCursor(&struCursor) != NORMAL)
	{
		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
					  szSql, GetSQLErrorMessage());
        FreeCursor(&struCursor);
		return EXCEPTION;
	}
	if (strcmp(getenv("DATABASE"), "mysql") == 0)
	{
		if(GetMySqlSequence(&nAlarmLogId, "alm_alarmlog")!=NORMAL)
		{
			PrintErrorLog(DBG_HERE,"获取查询设置流水号错误\n");
			return EXCEPTION;
		}
	}
	else
	{
		if(GetDbSequence(&nAlarmLogId, "SEQ_ALARMLOG")!=NORMAL)
		{
			PrintErrorLog(DBG_HERE,"获取查询设置流水号错误\n");
			FreeCursor(&struCursor);
			return EXCEPTION;
		}
	}
	
	struAlarmPara.nAlarmLogId = nAlarmLogId;
	
	strcpy(struAlarmPara.szAlarmId ,GetTableFieldValue(&struCursor, "alm_AlarmId"));
	strcpy(struAlarmPara.szAlarmLevelId, GetTableFieldValue(&struCursor, "alm_LevelId"));
	strcpy(struAlarmPara.szAlarmName, GetTableFieldValue(&struCursor, "alm_Name"));
	//strcpy(struAlarmPara.alarmLevelName, GetTableFieldValue(&struCursor, "alm_LevelName"));
    FreeCursor(&struCursor);

    PrintDebugLog(DBG_HERE,"szAlarmObjList=[%s],szAlarmObjId[%s]\n", struAlarmPara.szAlarmObjList, struAlarmPara.szAlarmObjId);
    if ((pszTemp = strstr(struAlarmPara.szAlarmObjList, struAlarmPara.szAlarmObjId)) != NULL)
    {
        memset(szOldAlarmObjId, 0, sizeof(szOldAlarmObjId));
        memcpy(szOldAlarmObjId, pszTemp, strlen(struAlarmPara.szAlarmObjId)+2);
        sprintf(szNewAlarmObjId, "%s:1", struAlarmPara.szAlarmObjId);
        
        memset(&struBindVar, 0, sizeof(struBindVar));
		struBindVar.struBind[0].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[0].VarValue.szValueChar, szOldAlarmObjId);
		struBindVar.nVarCount++;
		
		struBindVar.struBind[1].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[1].VarValue.szValueChar, szNewAlarmObjId);
		struBindVar.nVarCount++;
		
		struBindVar.struBind[2].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[2].VarValue.szValueChar, GetSysDateTime());
		struBindVar.nVarCount++;
		
		struBindVar.struBind[3].nVarType = SQLT_INT;
		struBindVar.struBind[3].VarValue.nValueInt =  nNeId;
		struBindVar.nVarCount++;
		
        sprintf(szSql, "update ne_Element set ne_AlarmObjList=REPLACE(ne_AlarmObjList, :v_0, :v_1),ne_LastUpdateTime =to_date( :v_2,'yyyy-mm-dd hh24:mi:ss'),ne_IsAlarm = 1 where  ne_NeId= :v_3");
        
        PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%s][%s][%s][%d]\n", szSql, szOldAlarmObjId, szNewAlarmObjId, GetSysDateTime(),  nNeId);
        if(BindExecuteSQL(szSql, &struBindVar) !=NORMAL ) 
	    {
		    PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    return EXCEPTION;
	    }
	    CommitTransaction();
	    
    }
    
    snprintf(szSql, sizeof(szSql), "insert into  alm_AlarmLog (alg_AlarmLogId,alg_AlarmId,alg_NeId,alg_AlarmTime,alg_AlarmStatusId,alg_AlarmObjId, alg_AlarmInfo)"
             " VALUES(%d, %s, %d, to_date( '%s','yyyy-mm-dd hh24:mi:ss'), 1, '%s', '%s')", 
             struAlarmPara.nAlarmLogId, struAlarmPara.szAlarmId, struAlarmPara.nNeId, struAlarmPara.szAlarmTime, struAlarmPara.szAlarmObjId, struAlarmPara.szAlarmInfo);
    PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
    if(ExecuteSQL(szSql) !=NORMAL) 
	{
		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		return EXCEPTION;
	}
	CommitTransaction();
	
	
    
    //数据汇总处理, 累加1
    memset(szSql, 0, sizeof(szSql));
    nAlarmId = atoi(struAlarmPara.szAlarmId);
    if ((nAlarmId >=1 && nAlarmId <=20) 
    	|| (nAlarmId >=56 && nAlarmId <=71)
    	|| (nAlarmId >=137 && nAlarmId <=139)
    	|| (nAlarmId >=167 && nAlarmId <=170)
    	|| (nAlarmId >=187 && nAlarmId <=189)
    	|| nAlarmId == 22 
    	|| nAlarmId == 30 
    	|| nAlarmId == 31
    	|| nAlarmId == 158
    	|| nAlarmId == 185
    )
    {
    	memset(&struBindVar, 0, sizeof(struBindVar));
		struBindVar.struBind[0].nVarType = SQLT_INT;
		struBindVar.struBind[0].VarValue.nValueInt =  nNeId;
		struBindVar.nVarCount++;
		
		struBindVar.struBind[1].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[1].VarValue.szValueChar, GetSystemDate());
		struBindVar.nVarCount++;

    	snprintf(szSql, sizeof(szSql), "update alm_collect_report set ALARM_%d_TIMES=ALARM_%d_TIMES + 1 where ne_neid = :v_0 and collect_date = to_date(:v_1, 'yyyymmdd')", nAlarmId, nAlarmId);
		PrintDebugLog(DBG_HERE, "开始执行SQL[%s][%d][%s]\n", szSql,	 nNeId, GetSystemDate());
		if(BindExecuteSQL(szSql, &struBindVar) != NORMAL)
		{
			PrintErrorLog(DBG_HERE, "执行SQL语句失败[%s][%s]\n",
				szSql, GetSQLErrorMessage());
    	    return EXCEPTION;
		}
		CommitTransaction();
	}
	
	if (struAlarmPara.nDeviceId != 1 && (nAlarmId == 1 || nAlarmId == 14 || nAlarmId == 137))//不是远端机
	{
		if (ExistTransferAlarm(struAlarmPara.nRepeaterId, struAlarmPara.nDeviceId, nAlarmId) == BOOLTRUE)
			return EXCEPTION;
	}
	STR szAlarmLogId[100];
	STR szYear[10], szMonth[10], szDay[10];
	
	memset(szYear, 0, sizeof(szYear));
	memset(szMonth, 0, sizeof(szMonth));
	memset(szDay, 0, sizeof(szDay));
	strncpy(szYear, struAlarmPara.szAlarmTime, 4);
	strncpy(szMonth, struAlarmPara.szAlarmTime+5, 2);
	strncpy(szDay, struAlarmPara.szAlarmTime+8, 2);
	sprintf(szAlarmLogId, "%s%s%s-%d", szYear, szMonth, szDay, struAlarmPara.nAlarmLogId);
	snprintf(szSql, sizeof(szSql), "insert into tf_AlarmLog_Trigger(Alg_Alarmlogid, alg_AlarmId, alg_NeId, alg_AlarmStatusId, alg_AlarmTime)"
			"values ('%s', %s, %d, %d, to_date( '%s','yyyy-mm-dd hh24:mi:ss'))",
			szAlarmLogId, struAlarmPara.szAlarmId,  struAlarmPara.nNeId, 0, struAlarmPara.szAlarmTime);
	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
    if(ExecuteSQL(szSql) !=NORMAL) 
	{
		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		return EXCEPTION;
	}
	CommitTransaction();
	
 	
    return NORMAL;  
		
}


RESULT AlarmAutoConfirm(int nNeId)
{
    STR szSql[MAX_SQL_LEN];
    STR szEnable[10];
    STR szCondition[100];
    STR szTemp[10];
	//取自动确认条件
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='AlarmAutoConfirm' and par_KeyName = 'Enabled'");
	GetSysParameter(szSql, szEnable);
	if (strcmp(szEnable, "TRUE") == 0)
	{
		sprintf(szSql, "par_SectionName ='AlarmAutoConfirm' and par_KeyName = 'Condition'");
		GetSysParameter(szSql, szCondition);
		sprintf(szTemp, "%s,", struAlarmPara.szAlarmId);
		if (strstr(szCondition, szTemp) == NULL)
		{
			return NORMAL;
		}
	    sprintf(szSql, "UPDATE alm_AlarmLog SET alg_ConfirmTime = to_date('%s','yyyy-mm-dd hh24:mi:ss'), alg_ConfirmName = '%s', alg_AlarmStatusId = 3,alg_ConfirmWay = 0 WHERE alg_AlarmLogId = %d",
	        GetSysDateTime(), "系统自动确认", struAlarmPara.nAlarmLogId);
	    if(ExecuteSQL(szSql) !=NORMAL ) 
	    {
		    PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    return EXCEPTION;
	    }
	    CommitTransaction();
	    
	}
    return NORMAL;
}


RESULT AlarmAutoClear(int nNeId)
{
    STR szSql[MAX_SQL_LEN];
    STR szEnable[10];
    STR szCondition[100];
    STR szTemp[10];
	//取自动清除条件
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='AlarmAutoClear' and par_KeyName = 'Enabled'");
	GetSysParameter(szSql, szEnable);
	if (strcmp(szEnable, "TRUE") == 0)
	{
		sprintf(szSql, "par_SectionName ='AlarmAutoClear' and par_KeyName = 'Condition'");
		GetSysParameter(szSql, szCondition);
		sprintf(szTemp, "%s,", struAlarmPara.szAlarmId);
		if (strstr(szCondition, szTemp) == NULL)
		{
			return NORMAL;
		}
	    sprintf(szSql, "UPDATE alm_AlarmLog SET alg_ClearTime = to_date( '%s','yyyy-mm-dd hh24:mi:ss'), alg_ClearUserName = '%s', alg_AlarmStatusId = 5 WHERE alg_AlarmLogId = %d",
	        GetSysDateTime(), "系统自动清除", struAlarmPara.nAlarmLogId);
	    if(ExecuteSQL(szSql) !=NORMAL ) 
	    {
		    PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    return EXCEPTION;
	    }
	    CommitTransaction();
	}
    return NORMAL;
}

RESULT AlarmCompress(int nNeId)
{
	CURSORSTRU struCursor;
	STR szSql[MAX_SQL_LEN];
	STR szEnable[10];
	INT nCount, nAlarmLogId;
	STR szCondition[2000];
	STR szTemp[100];
	TBINDVARSTRU struBindVar;
	
	//取告警压缩条件
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_general_config' and par_KeyName = 'alarm_compres'");
	GetSysParameter(szSql, szEnable);
	if (strcmp(szEnable, "true") == 0)
	{
		//找告警压缩条件
		memset(&struBindVar, 0, sizeof(struBindVar));
		struBindVar.struBind[0].nVarType = SQLT_INT;
		struBindVar.struBind[0].VarValue.nValueInt = atoi(struAlarmPara.szAlarmId);
		struBindVar.nVarCount++;
		memset(szSql, 0, sizeof(szSql));
		sprintf(szSql,"select alm_compress from alm_alarm  where alm_alarmid = :v_0 ");
	    PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%s]\n", szSql, struAlarmPara.szAlarmId);
	    if(BindSelectTableRecord(szSql, &struCursor, &struBindVar) != NORMAL)
	    {
	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    				  szSql, GetSQLErrorMessage());
	    	return EXCEPTION;
	    }
	    if(FetchCursor(&struCursor) != NORMAL)
	    {
	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
	    				  szSql, GetSQLErrorMessage());
	    	FreeCursor(&struCursor);
	    	return EXCEPTION;
	    }
	    if (atoi(GetTableFieldValue(&struCursor, "alm_compress")) == 0)
	    {
	    	FreeCursor(&struCursor);
	    	return NORMAL;
	    }
	    FreeCursor(&struCursor);

		//
		memset(&struBindVar, 0, sizeof(struBindVar));
		struBindVar.struBind[0].nVarType = SQLT_INT;
		struBindVar.struBind[0].VarValue.nValueInt = nNeId;
		struBindVar.nVarCount++;
		
		struBindVar.struBind[1].nVarType = SQLT_INT;
		struBindVar.struBind[1].VarValue.nValueInt = atoi(struAlarmPara.szAlarmId);
		struBindVar.nVarCount++;
		
		memset(szSql, 0, sizeof(szSql));
		sprintf(szSql,"select count(*) as almcount from  alm_AlarmLog  where alg_NeId = :v_0 and  alg_AlarmId = :v_1 and alg_AlarmStatusId < 4");
	    PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%d][%s]\n", szSql, nNeId, struAlarmPara.szAlarmId);
	    if(BindSelectTableRecord(szSql, &struCursor, &struBindVar) != NORMAL)
	    {
	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    				  szSql, GetSQLErrorMessage());
	    	return EXCEPTION;
	    }
	    if(FetchCursor(&struCursor) != NORMAL)
	    {
	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
	    				  szSql, GetSQLErrorMessage());
	    	FreeCursor(&struCursor);
	    	return EXCEPTION;
	    }
	    nCount = atoi(GetTableFieldValue(&struCursor, "almcount"));
	    FreeCursor(&struCursor);
	    //必须有2条以上的记录才进行压缩
	    if (nCount > 1)
	    {
	    	memset(szSql, 0, sizeof(szSql));
			sprintf(szSql,"select alg_AlarmLogId from  alm_AlarmLog  where alg_NeId = :v_0 and  alg_AlarmId = :v_1 and alg_AlarmStatusId < 4 and alg_compressState = 1");
	    	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql, nNeId, struAlarmPara.szAlarmId);
	    	if(BindSelectTableRecord(szSql, &struCursor, &struBindVar) != NORMAL)
	    	{
	    		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    					  szSql, GetSQLErrorMessage());
	    		return EXCEPTION;
	    	}
	    	if(FetchCursor(&struCursor) == NORMAL)
	    	{
	    		nAlarmLogId = atoi(GetTableFieldValue(&struCursor, "alg_AlarmLogId"));
	    		FreeCursor(&struCursor);
	    		
	    		memset(&struBindVar, 0, sizeof(struBindVar));
				struBindVar.struBind[0].nVarType = SQLT_INT;
				struBindVar.struBind[0].VarValue.nValueInt = nCount;
				struBindVar.nVarCount++;
				
				struBindVar.struBind[1].nVarType = SQLT_INT;
				struBindVar.struBind[1].VarValue.nValueInt = nAlarmLogId;
				struBindVar.nVarCount++;
				
				sprintf(szSql, "update alm_AlarmLog set alg_compressCount = :v_0 where alg_AlarmLogId = :v_1");
	        	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql,	 nCount, nAlarmLogId);
	        	if(BindExecuteSQL(szSql, &struBindVar) !=NORMAL ) 
	    		{
		    		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    		return EXCEPTION;
	    		}
	    		CommitTransaction();
	    		
	    	}
	    	else
	    	{
	    		FreeCursor(&struCursor);
	    		
	    		//找最早的一条没有做过压缩的记录，把它作为主压缩记录
	    		memset(szSql, 0, sizeof(szSql));
				sprintf(szSql,"select min(alg_AlarmLogId) as alg_AlarmLogId from alm_AlarmLog  where alg_NeId = :v_0 and  alg_AlarmId = :v_1 and alg_AlarmStatusId < 4 ");
	    		PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%d][%s]\n", szSql, nNeId, struAlarmPara.szAlarmId);
	    		if(BindSelectTableRecord(szSql, &struCursor, &struBindVar) != NORMAL)
	    		{
	    			PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    					  szSql, GetSQLErrorMessage());
	    			return EXCEPTION;
	    		}
	    		if(FetchCursor(&struCursor) != NORMAL)
	    		{
	    			PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n",  szSql);
        			FreeCursor(&struCursor);
	    			return EXCEPTION;
	    		}
	    		nAlarmLogId = atoi(GetTableFieldValue(&struCursor, "alg_AlarmLogId"));
	    		FreeCursor(&struCursor);
	    		
	    		memset(&struBindVar, 0, sizeof(struBindVar));
				struBindVar.struBind[0].nVarType = SQLT_INT;
				struBindVar.struBind[0].VarValue.nValueInt = nCount;
				struBindVar.nVarCount++;
				
				struBindVar.struBind[1].nVarType = SQLT_INT;
				struBindVar.struBind[1].VarValue.nValueInt = nAlarmLogId;
				struBindVar.nVarCount++;
				
	    		sprintf(szSql, "update alm_AlarmLog set alg_compressCount = :v_0 ,alg_compressState = 1 where alg_AlarmLogId = :v_1");
	        	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql, nCount, nAlarmLogId);
	        	if(BindExecuteSQL(szSql, &struBindVar) !=NORMAL ) 
	    		{
		    		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    		return EXCEPTION;
	    		}
	    		CommitTransaction();
	    	}
	    	memset(&struBindVar, 0, sizeof(struBindVar));
			struBindVar.struBind[0].nVarType = SQLT_INT;
			struBindVar.struBind[0].VarValue.nValueInt = nAlarmLogId;
			struBindVar.nVarCount++;
			
			struBindVar.struBind[1].nVarType = SQLT_INT;
			struBindVar.struBind[1].VarValue.nValueInt = nNeId;
			struBindVar.nVarCount++;
			
			struBindVar.struBind[2].nVarType = SQLT_INT;
			struBindVar.struBind[2].VarValue.nValueInt = atoi(struAlarmPara.szAlarmId);
			struBindVar.nVarCount++;
			
			struBindVar.struBind[3].nVarType = SQLT_INT;
			struBindVar.struBind[3].VarValue.nValueInt = nAlarmLogId;
			struBindVar.nVarCount++;
		
	        sprintf(szSql, "update alm_AlarmLog set alg_compressShowId = :v_0, alg_compressState = 0 where  alg_NeId = :v_1 and  alg_AlarmId = :v_2 and alg_AlarmStatusId < 4 and alg_AlarmLogId <> :v_3 and (alg_compressState <> 0  or alg_compressState is null)");
	    	PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%d][%d][%s][%d]\n", szSql, nAlarmLogId, nNeId, struAlarmPara.szAlarmId, nAlarmLogId);	
	    	if(BindExecuteSQL(szSql, &struBindVar) !=NORMAL ) 
	    	{
		    	PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    	return EXCEPTION;
	    	}
	    	CommitTransaction();
	    	
	    }

	}
	
    return NORMAL;
}

//频繁上报
RESULT AlarmFrequent(int nMaintainLogId, PSTR pszCondition)
{
	CURSORSTRU struCursor;
    STR szSql[MAX_SQL_LEN];
    STR szCount[10];
    STR szHour[10];
    STR szEnable[10];
    INT nStartAlarmLogId, nCount;
    UINT nAlarmFrequentId;
    STR szStartTime[20], szStyle[100];
    STR szCondition[150];
    bufclr(szStyle);
    
    if (strcmp(pszCondition, "chkFrqAlarm") == 0)
    	strcpy(szStyle, "New Alarm");
    else if (strcmp(pszCondition, "chkFrqAlarmClear") == 0)
    	strcpy(szStyle, "Alarm Recovery");
    else if (strcmp(pszCondition, "chkFrqNeBulid") == 0)
    	strcpy(szStyle, "Initial Operating Report");
    else if (strcmp(pszCondition, "chkFrqNeRevamp") == 0)
    	strcpy(szStyle, "Configuation Modification Report");
    else if (strcmp(pszCondition, "chkFrqNeRebuild") == 0)
    	strcpy(szStyle, "Fault Recovery Report");
    else if (strcmp(pszCondition, "chkFrqNeCheck") == 0)
    	strcpy(szStyle, "Routine Check Report");

	//取频繁告警条件
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_general_config' and par_KeyName = 'alarm_freq'");
	GetSysParameter(szSql, szEnable);
  	
	if(strcmp(szEnable, "true") == 0)
	{	
		sprintf(szSql, "par_SectionName ='alarm_freq_config' and par_KeyName = '%s'", pszCondition);
		GetSysParameter(szSql, szCondition);
		if (strcmp(szCondition, "true") != 0)
		{			
			return NORMAL;
		} 		
	    sprintf(szSql, "par_SectionName = 'alarm_freq_config' and par_KeyName = 'hour'");
	    GetSysParameter(szSql, szHour);
	    sprintf(szSql, "par_SectionName = 'alarm_freq_config' and par_KeyName = 'count'");
	    GetSysParameter(szSql, szCount);
  	    
	    if ((strcmp(szHour, "0") == 0) || (strcmp(szHour, "") == 0)
	        || (strcmp(szCount, "0") == 0) || (strcmp(szCount, "") == 0))
	    {
	        PrintErrorLog(DBG_HERE,"获取频繁告警条数和时间错误\n");
	        return EXCEPTION;
	    }
  	    
	    bufclr(szHour);
	    memcpy(szHour, GetSystemTime(), 2);
	    
	    memset(szSql, 0, sizeof(szSql));
    	sprintf(szSql,"SELECT count(*) as v_count from man_MaintainLog where  mnt_NeId = %d and mnt_Style = '%s' and mnt_EventTime >= to_date('%s000000', 'yyyymmddhh24miss') and mnt_EventTime <= to_date('%s235959', 'yyyymmddhh24miss')", 
	            struAlarmPara.nNeId, szStyle, GetSystemDate(), GetSystemDate());
	    PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
	    if(SelectTableRecord(szSql, &struCursor) != NORMAL)
	    {
	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    				  szSql, GetSQLErrorMessage());
	    	return EXCEPTION;
	    }
	    if(FetchCursor(&struCursor) != NORMAL)
	    {
	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
	    				  szSql, GetSQLErrorMessage());
	    	FreeCursor(&struCursor);
	    	return EXCEPTION;
	    }
	    nCount = atoi(GetTableFieldValue(&struCursor, "v_count"));
	    FreeCursor(&struCursor);
	    
	    if (nCount >= atoi(szCount))
	    {
	    	memset(szSql, 0, sizeof(szSql));
    		sprintf(szSql,"SELECT  afq_AlarmFrequentId, afq_Count from  alm_AlarmFrequent WHERE afq_NeId = %d  and afq_StartTime >= to_date('%s000000', 'yyyymmddhh24miss') and afq_StartTime <= to_date('%s235959', 'yyyymmddhh24miss')", 
	    	        struAlarmPara.nNeId, GetSystemDate(), GetSystemDate());
	    	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
	    	if(SelectTableRecord(szSql, &struCursor) != NORMAL)
	    	{
	    		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    					  szSql, GetSQLErrorMessage());
	    		return EXCEPTION;
	    	}
	    	if(FetchCursor(&struCursor) == NORMAL)
	    	{
	    		nAlarmFrequentId = atoi(GetTableFieldValue(&struCursor, "afq_AlarmFrequentId"));
	    		FreeCursor(&struCursor);
				sprintf(szSql, "update alm_AlarmFrequent set afq_Count = %d,afq_EndTime = to_date('%s', 'yyyy-mm-dd hh24:mi:ss'),afq_EndAlarmLogId = %d where afq_NeId = %d and afq_AlarmFrequentId = %d",
	        		 nCount, GetSysDateTime(), nMaintainLogId, struAlarmPara.nNeId, nAlarmFrequentId);
	    	}
	    	else
	    	{
	    		FreeCursor(&struCursor);
	    		memset(szSql, 0, sizeof(szSql));
	    		if (strcmp(getenv("DATABASE"), "mysql") == 0)
	    			sprintf(szSql,"SELECT  mnt_MaintainLogId, mnt_EventTime as mnt_EventTime from man_MaintainLog where  mnt_NeId = %d and mnt_Style = '%s' and mnt_EventTime >= to_date('%s000000', 'yyyymmddhh24miss') and mnt_EventTime <= to_date('%s235959', 'yyyymmddhh24miss') order by mnt_MaintainLogId", 
	    	        	struAlarmPara.nNeId, szStyle, GetSystemDate(), GetSystemDate());
	    	    else
    	    		sprintf(szSql,"SELECT  mnt_MaintainLogId, to_char(mnt_EventTime, 'yyyy-mm-dd hh24:mi:ss') as mnt_EventTime from man_MaintainLog where  mnt_NeId = %d and mnt_Style = '%s' and mnt_EventTime >= to_date('%s000000', 'yyyymmddhh24miss') and mnt_EventTime <= to_date('%s235959', 'yyyymmddhh24miss') order by mnt_MaintainLogId", 
	    	        	struAlarmPara.nNeId, szStyle, GetSystemDate(), GetSystemDate());
	    	    PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
	    	    if(SelectTableRecord(szSql, &struCursor) != NORMAL)
	    	    {
	    	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
	    					  szSql, GetSQLErrorMessage());
	    		    return EXCEPTION;
	    	    }
	    	    if(FetchCursor(&struCursor) != NORMAL)
	    	    {
	    	    	PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
	    				  szSql, GetSQLErrorMessage());
	    			FreeCursor(&struCursor);
	    			return EXCEPTION;
	    	    }
	    	    nStartAlarmLogId = atoi(GetTableFieldValue(&struCursor, "mnt_MaintainLogId"));
	    	    strcpy(szStartTime, GetTableFieldValue(&struCursor, "mnt_EventTime"));
	    	    FreeCursor(&struCursor);
	    	    
	    		GetDbSerial(&nAlarmFrequentId, "alm_AlarmFrequent");
	    		snprintf(szSql, sizeof(szSql),
	    			"insert into  alm_AlarmFrequent(afq_AlarmFrequentId,afq_NeId,afq_Count,afq_StartAlarmLogId,afq_StartTime,afq_EndAlarmLogId,afq_EndTime,afq_End)"
         			" VALUES(%d, %d,%d, %d, to_date('%s', 'yyyy-mm-dd hh24:mi:ss'),%d, to_date('%s', 'yyyy-mm-dd hh24:mi:ss'),0)",
	        		nAlarmFrequentId,  struAlarmPara.nNeId, nCount, nStartAlarmLogId, szStartTime, nMaintainLogId, GetSysDateTime());
	    	}
	    	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
	    	if(ExecuteSQL(szSql) !=NORMAL ) 
	    	{
		    	PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    	return EXCEPTION;
	    	}
	    	CommitTransaction();
	    }

	}
	
    return NORMAL;
}

RESULT SaveAlarmTransferLog(int nPersonId, PSTR pszMobile)
{
	CURSORSTRU struCursor;
    STR szSql[MAX_SQL_LEN];
	UINT nTransferLogId;		//获取编号
	STR szMsgCont[500];
	
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "select ne_name, ne_cellid, ne_basestation from ne_element  where ne_neid = %d", struAlarmPara.nNeId);
	PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
	if(SelectTableRecord(szSql, &struCursor) != NORMAL)
	{
		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
					  szSql, GetSQLErrorMessage());
		return EXCEPTION;
	}
	if(FetchCursor(&struCursor) != NORMAL)
	{
		FreeCursor(&struCursor);
		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
					  szSql, GetSQLErrorMessage());
		return EXCEPTION;
	}
	if (struAlarmPara.bIsNewAlarm == BOOLTRUE)
		sprintf(szMsgCont, "%s %s %s %s", TrimAllSpace(GetTableFieldValue(&struCursor, "ne_name")),
			GetTableFieldValue(&struCursor, "ne_basestation"), GetTableFieldValue(&struCursor, "ne_cellid"), struAlarmPara.szAlarmName);
	else
		sprintf(szMsgCont, "%s %s %s %s clear", TrimAllSpace(GetTableFieldValue(&struCursor, "ne_name")),
			GetTableFieldValue(&struCursor, "ne_basestation"), GetTableFieldValue(&struCursor, "ne_cellid"), struAlarmPara.szAlarmName);
	FreeCursor(&struCursor);
	
	
	GetDbSerial(&nTransferLogId, "alarmtransferlog");
	snprintf(szSql, sizeof(szSql), "insert into  alm_alarmtransferlog (atl_transferlogid,atl_personid,atl_time, atl_moble,atl_interface, atl_alarmlogid, atl_neid, atl_alarmid, atl_alarmstate)"
             " VALUES(%d, %d, to_date( '%s','yyyy-mm-dd hh24:mi:ss'), '%s',  '%s', %d, %d, %s, 0)", 
             nTransferLogId, nPersonId, GetSysDateTime(), pszMobile, szMsgCont, struAlarmPara.nAlarmLogId, struAlarmPara.nNeId, struAlarmPara.szAlarmId);
    PrintDebugLog(DBG_HERE, "执行SQL语句[%s]\n", szSql);
    if(ExecuteSQL(szSql) !=NORMAL) 
	{
		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		return EXCEPTION;
	}
	CommitTransaction();
	return NORMAL;
}



RESULT TransferAlarm()
{
	CURSORSTRU struCursor;
    STR szSql[MAX_SQL_LEN];
    STR szTime[10];
    STR szEnable[10];
    INT nPersonId, nCompanyId, nAreaId, nSiteId;
    STR szMobile[20];
    STR szCondition[1000], szCompany[1000], szArea[1000];
    STR szTempCond[100], szTempComp[100], szTempArea[100];
    STR szAlarmTime[20], szClearTime[20];
    
    //取告警前转条件
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_general_config' and par_KeyName = 'alarm_forward'");
	GetSysParameter(szSql, szEnable);
	if(strcmp(szEnable, "true") != 0)
	{
		return EXCEPTION;
	}
	//判断告警时间段
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_forward' and par_KeyName = 'forwardAllDay'");
	GetSysParameter(szSql, szTime);
	if(strcmp(szTime, "true") != 0 )
	{
		time_t struTimeNow;
		struct tm struTmNow;
		STR szBeginTime[3],szEndTime[3];
		STR szAlarmBeginTime[30],szAlarmEndTime[30];
		
		sprintf(szSql, "par_SectionName ='alarm_forward' and par_KeyName = 'fromHour'");
		GetSysParameter(szSql, szBeginTime);
		
		sprintf(szSql, "par_SectionName ='alarm_forward' and par_KeyName = 'toHour'");
		GetSysParameter(szSql, szEndTime);
				
		time(&struTimeNow);
		struTmNow=*localtime(&struTimeNow);
		
        snprintf(szAlarmBeginTime, sizeof(szAlarmBeginTime), "%04d-%02d-%02d %s:00:00", 
			struTmNow.tm_year + 1900, struTmNow.tm_mon + 1, struTmNow.tm_mday, szBeginTime);
		snprintf(szAlarmEndTime, sizeof(szAlarmEndTime), "%04d-%02d-%02d %s:00:00", 
			struTmNow.tm_year + 1900, struTmNow.tm_mon + 1, struTmNow.tm_mday, szEndTime);
		
		PrintDebugLog(DBG_HERE,"告警时间段[%s][%s]\n",szAlarmBeginTime,szAlarmEndTime);
        if ((int)time(NULL) < (int)MakeITimeFromSTime(szAlarmBeginTime) || 
        	(int)time(NULL) > (int)MakeITimeFromSTime(szAlarmEndTime))
        {
        	return EXCEPTION;
        }
	}
	/*
	//判断不发送自动确认
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_forward' and par_KeyName = 'noAutoConfirm'");
	GetSysParameter(szSql, szEnable);
	if(strcmp(szEnable, "TRUE") == 0 && struAlarmPara.nAlarmAutoConfirmSuccess ==1)
	{
		return EXCEPTION;
	}
	//判断不发送自动清除
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_forward' and par_KeyName = 'noAutoClear'");
	GetSysParameter(szSql, szEnable);
	if(strcmp(szEnable, "TRUE") == 0 && struAlarmPara.nAlarmAutoClearSuccess ==1)
	{
		return EXCEPTION;
	}
	*/
	//判断是否有重复告警记录
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "par_SectionName ='alarm_forward' and par_KeyName = 'onlyOne'");
	GetSysParameter(szSql, szEnable);
	if(strcmp(szEnable, "true") == 0 && struAlarmPara.bIsNewAlarm == BOOLTRUE) //只有告警要判断
	{
		memset(szSql, 0, sizeof(szSql));
		if (strcmp(getenv("DATABASE"), "mysql") == 0)
			sprintf(szSql, "select max(atl_time) as alarmtime from alm_alarmtransferlog where atl_neId= %d and atl_alarmId = %s and atl_alarmstate = 1 and to_char(atl_time,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd')",
				struAlarmPara.nNeId, struAlarmPara.szAlarmId);
		else
			sprintf(szSql, "select to_char(max(atl_time), 'yyyymmddhh24miss') as alarmtime from alm_alarmtransferlog where atl_neId= %d and atl_alarmId = %s and atl_alarmstate = 1 and to_char(atl_time,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd')",
				struAlarmPara.nNeId, struAlarmPara.szAlarmId);
		PrintDebugLog(DBG_HERE,"执行SQL语句[%s]\n",szSql);
		if(SelectTableRecord(szSql,&struCursor) != NORMAL)
		{
			PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
			return EXCEPTION;
		}
		if(FetchCursor(&struCursor) == NORMAL)
		{
			strcpy(szAlarmTime, TrimAllSpace(GetTableFieldValue(&struCursor, "alarmtime")));
		    FreeCursor(&struCursor);
		    //存在多条告警
			if (strlen(szAlarmTime) >= 14)
			{
				memset(szSql, 0, sizeof(szSql));
				if (strcmp(getenv("DATABASE"), "mysql") == 0)
					sprintf(szSql, "select max(atl_time) as cleartime from alm_alarmtransferlog where atl_neId= %d and atl_alarmId = %s and atl_alarmstate = 7 and to_char(atl_time,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd')",
						struAlarmPara.nNeId, struAlarmPara.szAlarmId);
				else
					sprintf(szSql, "select to_char(max(atl_time), 'yyyymmddhh24miss') as cleartime from alm_alarmtransferlog where atl_neId= %d and atl_alarmId = %s and atl_alarmstate = 7 and to_char(atl_time,'yyyy-mm-dd') = to_char(sysdate,'yyyy-mm-dd')",
						struAlarmPara.nNeId, struAlarmPara.szAlarmId);
				PrintDebugLog(DBG_HERE,"执行SQL语句[%s]\n",szSql);
				if(SelectTableRecord(szSql,&struCursor) != NORMAL)
				{
					PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
					return EXCEPTION;
				}
				if(FetchCursor(&struCursor) != NORMAL)
				{
				    FreeCursor(&struCursor);
				    return BOOLTRUE;//0条恢复,重复
				}
				strcpy(szClearTime, TrimAllSpace(GetTableFieldValue(&struCursor, "cleartime")));
				FreeCursor(&struCursor);
				
				//连续多条告警，0条恢复, 重复
				if (strlen(szClearTime) == 0)
					return BOOLTRUE;
					
				if (strcmp(szClearTime, szAlarmTime) < 0 ) //恢复后有新的告警
					return BOOLTRUE;

			}
		}
		FreeCursor(&struCursor);

	}
	
	memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "select ne_companyid, ne_areaid, ne_sitelevelid from ne_element  where ne_neid =  %d ",	struAlarmPara.nNeId);
	PrintDebugLog(DBG_HERE,"执行SQL语句[%s]\n",szSql);
	if(SelectTableRecord(szSql,&struCursor) != NORMAL)
	{
		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		return EXCEPTION;
	}
	if(FetchCursor(&struCursor) != NORMAL)
	{
		PrintDebugLog(DBG_HERE,"执行SQL语句[%s]无记录\n",szSql);
		FreeCursor(&struCursor);
		return EXCEPTION;
	}
	nCompanyId = atoi(GetTableFieldValue(&struCursor,"ne_companyid"));
	nAreaId = atoi(GetTableFieldValue(&struCursor,"ne_areaid"));
	nSiteId = atoi(GetTableFieldValue(&struCursor,"ne_sitelevelid"));
	FreeCursor(&struCursor);
	
	
	//查找是否有告警前转的手机号
	memset(szSql, 0, sizeof(szSql));
	snprintf(szSql, sizeof(szSql),
		 "select id, phone,alarmcond, companys, districts from alm_alarmforward "
		 " where smsforward = 1 and alarmcond like '%%%s%%' "
		 " and companys like '%%%d%%' and districts like '%%%d%%' and slevel like '%%%d%%'", 
		 struAlarmPara.szAlarmId, nCompanyId, nAreaId, nSiteId);
	PrintDebugLog(DBG_HERE,"执行SQL语句[%s]\n",szSql);
	if(SelectTableRecord(szSql,&struCursor) != NORMAL)
	{
		PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		return EXCEPTION;
	}
	while(FetchCursor(&struCursor) == NORMAL)
	{
		nPersonId = atoi(GetTableFieldValue(&struCursor,"id"));
		strcpy(szMobile, GetTableFieldValue(&struCursor,"phone"));
		if (strlen(szMobile) != 11) continue;
		
		sprintf(szCondition, "%s,", TrimAllSpace(GetTableFieldValue(&struCursor,"alarmcond")));
		sprintf(szTempCond, "%s,", struAlarmPara.szAlarmId);
		if (strncmp(szCondition, szTempCond, strlen(szTempCond)) != 0) //不是第一个字符
			sprintf(szTempCond, ",%s,", struAlarmPara.szAlarmId);
		
		sprintf(szCompany, "%s,", TrimAllSpace(GetTableFieldValue(&struCursor,"companys")));
		sprintf(szTempComp, "%d,", nCompanyId);
		if (strncmp(szCompany, szTempComp, strlen(szTempComp)) != 0) 
			sprintf(szTempComp, ",%d,", nCompanyId);
		
		sprintf(szArea, "%s,", TrimAllSpace(GetTableFieldValue(&struCursor,"districts")));
		sprintf(szTempArea, "%d,", nAreaId);
		if (strncmp(szArea, szTempArea, strlen(szTempArea)) != 0)
			sprintf(szTempArea, ",%d,", nAreaId);
		
		if (strstr(szCondition, szTempCond) == NULL || strstr(szCompany, szTempComp) == NULL 
			|| strstr(szArea, szTempArea) == NULL) 
			continue;
		else
			SaveAlarmTransferLog(nPersonId, szMobile);
	}
	FreeCursor(&struCursor);
	
	
    return NORMAL;
}



RESULT DealNewAlarm(PXMLSTRU pstruXml)
{
    int nResult; // 每步是否执行成功
    char szAlarmTime[30];
    
    memset(&struAlarmPara, 0, sizeof(ALARMPARAMETER));
    struAlarmPara.bIsNewAlarm = BOOLTRUE;
    struAlarmPara.nNeId = atoi(DemandStrInXmlExt(pstruXml, "<omc>/<网元编号>"));
    struAlarmPara.nRepeaterId = atoi(DemandStrInXmlExt(pstruXml, "<omc>/<站点编号>"));
    struAlarmPara.nDeviceId = atoi(DemandStrInXmlExt(pstruXml, "<omc>/<设备编号>"));
    
    strcpy(struAlarmPara.szAlarmObjId, DemandStrInXmlExt(pstruXml, "<omc>/<告警对象>"));
    //strcpy(struAlarmPara.szAlarmObjId, pszAlarmObjId);
    strcpy(struAlarmPara.szAlarmObjList, DemandStrInXmlExt(pstruXml, "<omc>/<告警列表>"));
    //strcpy(struAlarmPara.szAlarmObjList, pszAlarmObjList);
    strcpy(szAlarmTime, DemandStrInXmlExt(pstruXml, "<omc>/<告警时间>"));
    if (strlen(szAlarmTime) == 19 && strncmp(szAlarmTime, GetSysDateTime(), 10) == 0)
		strcpy(struAlarmPara.szAlarmTime, szAlarmTime);
    else
    	strcpy(struAlarmPara.szAlarmTime, GetSysDateTime());
	//电平强度告警信息
    if (strcmp(struAlarmPara.szAlarmObjId, "0704") == 0)
    {
    	sprintf(struAlarmPara.szAlarmInfo, "%s, 服务小区号=%s, 电平强度=%s", struAlarmPara.szAlarmTime,
    		DemandStrInXmlExt(pstruXml, "<omc>/<服务小区>"), DemandStrInXmlExt(pstruXml, "<omc>/<电平强度>"));
    }
    //添加到告警日志表alm_AlarmLog中
	nResult = SaveAlarmLog(struAlarmPara.nNeId);
	if (nResult == EXCEPTION)
	{
		PrintErrorLog(DBG_HERE,"添加到告警日志表alm_AlarmLog和更新网元告警列表错误\n");
		return EXCEPTION;
	}
	/*
	//告警自动确认
	nResult = AlarmAutoConfirm(struAlarmPara.nNeId);
	if (nResult == EXCEPTION)
	{
	    PrintErrorLog(DBG_HERE,"告警自动确认发生错误\n");
		return EXCEPTION;
	}
	struAlarmPara.nAlarmAutoConfirmSuccess = nResult;

	//告警自动清除
	nResult = AlarmAutoClear(struAlarmPara.nNeId);
	if (nResult == EXCEPTION)
	{
	    PrintErrorLog(DBG_HERE,"告警自动清除发生错误\n");
		return EXCEPTION;
	}
	struAlarmPara.nAlarmAutoClearSuccess = nResult;

	if (nResult == NORMAL)//告警如果自动清除成功将不在执行告警压缩
	*/
	{
		//告警压缩
		nResult = AlarmCompress(struAlarmPara.nNeId);
		if (nResult == EXCEPTION)
		{
		    PrintErrorLog(DBG_HERE,"告警压缩发生错误\n");
		    return EXCEPTION;
		}
	}
	

	//告警前转
	nResult = TransferAlarm();
	if (nResult == EXCEPTION)
	{
		return EXCEPTION;
	}
	return NORMAL;
	
}
//告警恢复
RESULT AlarmComeback(PXMLSTRU pstruXml)
{
    CURSORSTRU struCursor;
	STR szSql[MAX_SQL_LEN];
	STR szOldAlarmObjId[20];
	STR szNewAlarmObjId[20];
	char szAlarmTime[30];
	PSTR pszTemp;
	TBINDVARSTRU struBindVar;
	
	memset(&struAlarmPara, 0, sizeof(ALARMPARAMETER));
	struAlarmPara.bIsNewAlarm = BOOLFALSE;
    struAlarmPara.nNeId = atoi(DemandStrInXmlExt(pstruXml, "<omc>/<网元编号>"));
    strcpy(struAlarmPara.szAlarmObjId, DemandStrInXmlExt(pstruXml, "<omc>/<告警对象>"));
    strcpy(struAlarmPara.szAlarmObjList, DemandStrInXmlExt(pstruXml, "<omc>/<告警列表>"));
    //strcpy(struAlarmPara.szAlarmObjList, pszAlarmObjList);
    strcpy(szAlarmTime, DemandStrInXmlExt(pstruXml, "<omc>/<告警时间>"));
    if (strlen(szAlarmTime) == 19 && strncmp(szAlarmTime, GetSysDateTime(), 10) == 0)
		strcpy(struAlarmPara.szAlarmTime, szAlarmTime);
    else
    	strcpy(struAlarmPara.szAlarmTime, GetSysDateTime());
    	
	memset(&struBindVar, 0, sizeof(struBindVar));
	struBindVar.struBind[0].nVarType = SQLT_STR;
	strcpy(struBindVar.struBind[0].VarValue.szValueChar, struAlarmPara.szAlarmObjId);
	struBindVar.nVarCount++;
	
    memset(szSql, 0, sizeof(szSql));
	sprintf(szSql, "select * from ALM_ALARM where alm_ObjId = :v_0 ");
	PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%s]\n", szSql, struAlarmPara.szAlarmObjId);
	if(BindSelectTableRecord(szSql, &struCursor, &struBindVar) != NORMAL)
	{
		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]错误, 信息为[%s]\n", \
					  szSql, GetSQLErrorMessage());
		return EXCEPTION;
	}
	if(FetchCursor(&struCursor) != NORMAL)
	{
		PrintErrorLog(DBG_HERE, "执行SQL语句[%s]没有找到记录\n", \
					  szSql, GetSQLErrorMessage());
        FreeCursor(&struCursor);
		return EXCEPTION;
	}
	
	strcpy(struAlarmPara.szAlarmId ,GetTableFieldValue(&struCursor, "alm_AlarmId"));
	strcpy(struAlarmPara.szAlarmLevelId , GetTableFieldValue(&struCursor, "alm_LevelId"));
	strcpy(struAlarmPara.szAlarmName, GetTableFieldValue(&struCursor, "alm_Name"));
	//strcpy(struAlarmPara.alarmLevelName, GetTableFieldValue(&struCursor, "alm_LevelName"));
    FreeCursor(&struCursor);
    
    memset(&struBindVar, 0, sizeof(struBindVar));
	struBindVar.struBind[0].nVarType = SQLT_STR;
	strcpy(struBindVar.struBind[0].VarValue.szValueChar, struAlarmPara.szAlarmTime);
	struBindVar.nVarCount++;
	
	struBindVar.struBind[1].nVarType = SQLT_INT;
	struBindVar.struBind[1].VarValue.nValueInt =  struAlarmPara.nNeId;
	struBindVar.nVarCount++;
			
	struBindVar.struBind[2].nVarType = SQLT_INT;
	struBindVar.struBind[2].VarValue.nValueInt = atoi(struAlarmPara.szAlarmId);
	struBindVar.nVarCount++;
	
    memset(szSql, 0, sizeof(szSql));
    snprintf(szSql, sizeof(szSql), 
        "UPDATE alm_AlarmLog SET alg_ClearTime = to_date(:v_0,'yyyy-mm-dd hh24:mi:ss'), alg_AlarmStatusId = 7 ,alg_compressCount = null,alg_compressShowId = null,"
    	"alg_compressState = null WHERE alg_NeId = :v_1 and alg_alarmId = :v_2 and alg_AlarmStatusId < 4 ");
    
    PrintDebugLog(DBG_HERE, "开始执行SQL[%s][%s][%d][%s]\n", szSql, struAlarmPara.szAlarmTime, struAlarmPara.nNeId, struAlarmPara.szAlarmId);
	if(BindExecuteSQL(szSql, &struBindVar) != NORMAL)
	{
		PrintErrorLog(DBG_HERE, "执行SQL语句失败[%s][%s]\n",
			szSql, GetSQLErrorMessage());
        return EXCEPTION;
	}
	CommitTransaction();
	if ((pszTemp = strstr(struAlarmPara.szAlarmObjList, struAlarmPara.szAlarmObjId)) != NULL)
    {
		memset(szOldAlarmObjId, 0, sizeof(szOldAlarmObjId));
        memcpy(szOldAlarmObjId, pszTemp, strlen(struAlarmPara.szAlarmObjId)+2);
        sprintf(szNewAlarmObjId, "%s:0", struAlarmPara.szAlarmObjId);
        
        memset(&struBindVar, 0, sizeof(struBindVar));
		struBindVar.struBind[0].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[0].VarValue.szValueChar, szOldAlarmObjId);
		struBindVar.nVarCount++;
		
		struBindVar.struBind[1].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[1].VarValue.szValueChar, szNewAlarmObjId);
		struBindVar.nVarCount++;
		
		struBindVar.struBind[2].nVarType = SQLT_STR;
		strcpy(struBindVar.struBind[2].VarValue.szValueChar, GetSysDateTime());
		struBindVar.nVarCount++;
		
		struBindVar.struBind[3].nVarType = SQLT_INT;
		struBindVar.struBind[3].VarValue.nValueInt =  struAlarmPara.nNeId;
		struBindVar.nVarCount++;
				
	
        sprintf(szSql, "update ne_Element set ne_AlarmObjList=REPLACE(ne_AlarmObjList, :v_0, :v_1),ne_LastUpdateTime =to_date( :v_2,'yyyy-mm-dd hh24:mi:ss'),ne_IsAlarm = 0 where  ne_NeId=:v_3");
        
        PrintDebugLog(DBG_HERE, "执行SQL语句[%s][%s][%s][%s][%d]\n", szSql, szOldAlarmObjId, szNewAlarmObjId, GetSysDateTime(),  struAlarmPara.nNeId);
        if(BindExecuteSQL(szSql, &struBindVar) !=NORMAL ) 
	    {
		    PrintErrorLog(DBG_HERE,"执行SQL语句[%s]失败[%s]\n",szSql,GetSQLErrorMessage());
		    return EXCEPTION;
	    }
	    CommitTransaction();
	    
	}
   
 
    
    return NORMAL;
}
